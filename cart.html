<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Shopping Cart - AlSaji Auto Parts</title>
  <link rel="stylesheet" href="css/style.css">
  <style>
    /* Mobile responsive styles for cart page */
    @media (max-width: 768px) {
      .cart-grid {
        grid-template-columns: 1fr !important;
        gap: 16px !important;
      }

      .cart-item {
        flex-direction: column !important;
        align-items: flex-start !important;
        gap: 12px !important;
        padding: 12px !important;
      }

      .cart-item-image {
        width: 60px !important;
        height: 60px !important;
      }

      .cart-item-details {
        width: 100% !important;
      }

      .cart-item-actions {
        width: 100%;
        justify-content: space-between;
      }

      .quantity-controls {
        margin-right: auto;
      }

      .cart-summary {
        order: -1; /* Move summary to top on mobile */
      }

      .wrap {
        padding: 8px 16px !important;
      }
    }

    /* Additional mobile optimizations */
    @media (max-width: 480px) {
      h1 {
        font-size: 24px !important;
      }

      .cart-item {
        padding: 10px !important;
      }

      .btn {
        padding: 12px 16px !important;
        font-size: 14px !important;
      }
    }

    /* Cart item styles */
    .cart-item-image {
      width: 80px;
      height: 80px;
      background: var(--w2);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .cart-item-details {
      flex: 1;
      min-width: 0; /* Prevent flex item from overflowing */
    }

    .cart-item-actions {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .quantity-controls {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .quantity-btn {
      width: 32px;
      height: 32px;
      border: 1px solid var(--w1);
      background: white;
      border-radius: 4px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .remove-btn {
      color: var(--red);
      background: none;
      border: none;
      cursor: pointer;
      padding: 4px 8px;
      white-space: nowrap;
    }
  </style>
</head>
<body style="visibility: hidden;">
  <!-- Header and Footer will be loaded dynamically by layout.js -->

  <main class="wrap">
    <h1>Shopping Cart</h1>

    <!-- Empty Cart State -->
    <div id="emptyCart" class="card" style="display: none; text-align: center; padding: 60px 20px;">
      <div style="font-size: 48px; margin-bottom: 20px;">ðŸ›’</div>
      <h2 style="margin-bottom: 12px;">Your cart is empty</h2>
      <p class="muted" style="margin-bottom: 24px;">Add some products to get started</p>
      <a href="shop.html" class="btn">Continue Shopping</a>
    </div>

    <!-- Cart with Items -->
    <div id="cartWithItems" style="display: none;">
      <div class="grid cart-grid" style="grid-template-columns:2fr 1fr;gap:24px">
        <div>
          <div class="card">
            <div id="cartItems">
              <!-- Dynamic cart items will be inserted here -->
            </div>
            <div class="row between" style="padding:12px;background:var(--w2);border-radius:0 0 12px 12px">
              <div id="subtotalText">Subtotal (0 items)</div>
              <div id="subtotalAmount" style="font-weight:600">IQD 0</div>
            </div>
          </div>
        </div>
        <div class="card cart-summary">
          <h3>Order Summary</h3>
          <div class="row between" style="margin:12px 0">
            <div class="muted">Order No.</div>
            <div id="orderID">No.</div>
          </div>
          <div class="row between" style="margin:12px 0">
            <div class="muted">Subtotal</div>
            <div id="summarySubtotal">IQD 0</div>
          </div>
          <div class="row between" style="margin:12px 0">
            <div class="muted">Shipping</div>
            <div id="shippingCost">IQD 5,000</div>
          </div>
          <div class="row between" style="margin:12px 0;padding-top:12px;border-top:1px solid var(--w1)">
            <div style="font-weight:600">Total</div>
            <div id="totalAmount" style="font-weight:600;color:var(--red)">IQD 0</div>
          </div>
          <button class="btn" style="width:100%;margin-top:16px" id="checkoutBtn">Proceed to Checkout</button>
          <a href="shop.html" class="btn secondary" style="width:100%;margin-top:8px;text-align:center;display:block;text-decoration:none">Continue Shopping</a>
        </div>
      </div>
    </div>
  </main>

  <!-- Footer will be loaded dynamically -->

  <!-- Load scripts -->
  <script src="data/static_api.js"></script>
  <script src="js/api.js"></script>
  <script src="js/cart-manager.js"></script>
  <script src="js/layout.js"></script>

  <script>
  class CartPage {
      constructor() {
          this.init();
      }

      async init() {
          console.log('ðŸ›’ Initializing cart page...');
          await this.loadCart();
          this.setupEventListeners();
          this.updateCartCount();
      }

      async loadCart() {
          try {
              // Wait for API to be available
              if (typeof alsajiAPI === 'undefined') {
                  console.log('Waiting for API...');
                  setTimeout(() => this.loadCart(), 100);
                  return;
              }

              const cartResult = await alsajiAPI.getCart();
              if (cartResult.success) {
                  this.renderCart(cartResult.cart);
              } else {
                  this.showEmptyCart();
              }
          } catch (error) {
              console.error('Failed to load cart:', error);
              this.showEmptyCart();
          }
      }

      renderCart(cart) {
          console.log('Rendering cart:', cart);

          if (!cart.items || cart.items.length === 0) {
              this.showEmptyCart();
              return;
          }

          // Show cart with items
          document.getElementById('emptyCart').style.display = 'none';
          document.getElementById('cartWithItems').style.display = 'block';

          // Render cart items
          const cartItemsContainer = document.getElementById('cartItems');
          cartItemsContainer.innerHTML = cart.items.map(item => `
              <div class="cart-item" data-item-id="${item.id}" style="padding:16px;border-bottom:1px solid var(--w1);display:flex;gap:16px;align-items:center">
                  <div class="cart-item-image">
                      ${item.image ?
                          `<img src="${item.image}" alt="${item.name}" style="width:100%;height:100%;object-fit:cover;border-radius:8px">` :
                          '<div class="muted">No Image</div>'
                      }
                  </div>
                  <div class="cart-item-details">
                      <h4 style="margin:0 0 8px 0;word-wrap:break-word">${this.escapeHtml(item.name)}</h4>
                      <div style="color:var(--red);font-weight:600;margin-bottom:8px">IQD ${(item.unit_price || 0).toLocaleString()}</div>
                      <div class="cart-item-actions">
                          <div class="quantity-controls">
                              <button class="quantity-btn" data-action="decrease" data-item-id="${item.id}">-</button>
                              <span style="min-width:40px;text-align:center">${item.quantity}</span>
                              <button class="quantity-btn" data-action="increase" data-item-id="${item.id}">+</button>
                          </div>
                          <button class="remove-btn" data-item-id="${item.id}">Remove</button>
                      </div>
                  </div>
                  <div style="text-align:right;flex-shrink:0">
                      <div style="font-weight:600;margin-bottom:8px">IQD ${(item.subtotal || 0).toLocaleString()}</div>
                  </div>
              </div>
          `).join('');

          // Update totals
          this.updateTotals(cart);
      }

      updateTotals(cart) {
          const itemCount = cart.item_count || 0;
          const subtotal = cart.total || 0;
          const shipping = 5000; // Fixed shipping cost
          const total = subtotal + shipping;

          // Update subtotal display
          document.getElementById('subtotalText').textContent = `Subtotal (${itemCount} ${itemCount === 1 ? 'item' : 'items'})`;
          document.getElementById('subtotalAmount').textContent = `IQD ${subtotal.toLocaleString()}`;

          // Update order summary
          document.getElementById('summarySubtotal').textContent = `IQD ${subtotal.toLocaleString()}`;
          document.getElementById('totalAmount').textContent = `IQD ${total.toLocaleString()}`;

          // Generate order ID
          document.getElementById('orderID').textContent = `#${Date.now().toString().slice(-6)}`;
      }

      showEmptyCart() {
          document.getElementById('emptyCart').style.display = 'block';
          document.getElementById('cartWithItems').style.display = 'none';
      }

      setupEventListeners() {
          // Quantity controls
          document.addEventListener('click', async (e) => {
              if (e.target.classList.contains('quantity-btn')) {
                  const itemId = parseInt(e.target.dataset.itemId);
                  const action = e.target.dataset.action;

                  await this.updateQuantity(itemId, action);
              }

              if (e.target.classList.contains('remove-btn')) {
                  const itemId = parseInt(e.target.dataset.itemId);
                  await this.removeItem(itemId);
              }
          });

          // Checkout button
          const checkoutBtn = document.getElementById('checkoutBtn');
          if (checkoutBtn) {
              checkoutBtn.addEventListener('click', () => {
                  this.proceedToCheckout();
              });
          }

          // Update cart count in header
          this.updateCartCount();
      }

      async updateQuantity(itemId, action) {
          try {
              const cartResult = await alsajiAPI.getCart();
              const cart = cartResult.cart;
              const item = cart.items.find(i => i.id === itemId);

              if (!item) return;

              let newQuantity = item.quantity;

              if (action === 'increase') {
                  newQuantity += 1;
              } else if (action === 'decrease') {
                  newQuantity = Math.max(1, item.quantity - 1);
              }

              const result = await alsajiAPI.updateCart(itemId, newQuantity);
              if (result.success) {
                  await this.loadCart(); // Reload cart
                  this.updateCartCount();
              } else {
                  alert('Failed to update quantity: ' + result.error);
              }
          } catch (error) {
              console.error('Failed to update quantity:', error);
              alert('Failed to update quantity');
          }
      }

      async removeItem(itemId) {
          if (!confirm('Are you sure you want to remove this item from your cart?')) {
              return;
          }

          try {
              const result = await alsajiAPI.removeFromCart(itemId);
              if (result.success) {
                  await this.loadCart(); // Reload cart
                  this.updateCartCount();
              } else {
                  alert('Failed to remove item: ' + result.error);
              }
          } catch (error) {
              console.error('Failed to remove item:', error);
              alert('Failed to remove item');
          }
      }

      async updateCartCount() {
          try {
              if (typeof alsajiAPI === 'undefined') return;

              const cartResult = await alsajiAPI.getCart();
              const count = cartResult.cart.item_count || 0;

              const cartCountElement = document.getElementById('cartCount');
              if (cartCountElement) {
                  cartCountElement.textContent = count;
              }
          } catch (error) {
              console.error('Failed to update cart count:', error);
          }
      }

      proceedToCheckout() {
          // Redirect to checkout page
          window.location.href = 'checkout.html';
      }

      escapeHtml(text) {
          if (!text) return '';
          const div = document.createElement('div');
          div.textContent = text;
          return div.innerHTML;
      }
  }

  // Initialize cart page after layout is loaded
  document.addEventListener('DOMContentLoaded', () => {
      // Let layout.js load the header and footer first
      // Then initialize cart page
      setTimeout(() => {
          window.cartPage = new CartPage();
      }, 200);
  });
  </script>

</body>
</html>