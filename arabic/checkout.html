<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Ø§Ù„Ø¯ÙØ¹ - Ø§Ù„Ø³Ø§Ø¬ÙŠ Ù„Ù‚Ø·Ø¹ ØºÙŠØ§Ø± Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª</title>
  <link rel="stylesheet" href="../css/style.css">
  <link rel="stylesheet" href="css/style-ar.css">
  <style>
    /* Mobile-first responsive styles */
    .form-group {
      margin-bottom: 16px;
    }

    .form-group label {
      display: block;
      margin-bottom: 6px;
      font-weight: 500;
      color: var(--text);
    }

    .form-group input,
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 12px;
      border: 1px solid var(--w3);
      border-radius: 6px;
      font-size: 14px;
      transition: border-color 0.2s;
      box-sizing: border-box;
    }

    .form-group input:focus,
    .form-group textarea:focus,
    .form-group select:focus {
      outline: none;
      border-color: var(--primary);
    }

    .payment-methods {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .payment-option {
      display: flex;
      align-items: center;
      padding: 12px;
      border: 1px solid var(--w3);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .payment-option:hover {
      border-color: var(--primary);
    }

    .payment-option input[type="radio"] {
      margin-right: 12px;
    }

    .payment-content {
      flex: 1;
    }

    .checkout-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 0;
      border-bottom: 1px solid var(--w1);
    }

    .checkout-item:last-child {
      border-bottom: none;
    }

    .checkout-item-image {
      width: 60px;
      height: 60px;
      background: var(--w2);
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .checkout-item-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 6px;
    }

    .checkout-item-details {
      flex: 1;
      min-width: 0; /* Prevents flex item from overflowing */
    }

    .checkout-item-name {
      font-weight: 500;
      margin-bottom: 4px;
      word-break: break-word;
    }

    .checkout-item-price {
      color: var(--red);
      font-weight: 600;
    }

    .checkout-item-quantity {
      color: var(--muted);
      font-size: 14px;
    }

    /* Mobile-specific styles */
    @media (max-width: 768px) {
      .grid {
        grid-template-columns: 1fr !important;
        gap: 16px;
      }

      .card {
        padding: 16px;
      }

      h1 {
        font-size: 1.5rem;
        margin-bottom: 16px;
      }

      h3 {
        font-size: 1.2rem;
        margin-bottom: 16px;
      }

      .form-group {
        margin-bottom: 14px;
      }

      .form-group input,
      .form-group textarea,
      .form-group select {
        padding: 10px;
        font-size: 16px; /* Prevents zoom on iOS */
      }

      .checkout-item {
        padding: 10px 0;
      }

      .checkout-item-image {
        width: 50px;
        height: 50px;
      }

      .checkout-item-name {
        font-size: 14px;
      }

      .checkout-item-price {
        font-size: 14px;
      }

      .btn {
        padding: 12px 16px;
        font-size: 16px;
      }

      .nav .wrap.row {
        flex-wrap: wrap;
        justify-content: center;
      }

      .nav .tab {
        padding: 8px 12px;
        font-size: 14px;
      }
    }

    /* Small mobile devices */
    @media (max-width: 480px) {
      .grid[style*="grid-template-columns: 1fr 1fr"] {
        grid-template-columns: 1fr !important;
        gap: 12px;
      }

      .card {
        padding: 12px;
      }

      .checkout-item {
        gap: 8px;
      }

      .checkout-item-image {
        width: 45px;
        height: 45px;
      }

      .checkout-item-name {
        font-size: 13px;
      }

      .checkout-item-price {
        font-size: 13px;
      }
    }
  </style>
</head>
<body>
<script src="../js/utils/pathHelper.js"></script>

  <script src="../data/static_api.js"></script>
  <script src="../js/api.js"></script>
  <script src="../js/cart-manager.js"></script>
  <script src="../js/main.js"></script>
  <script src="../js/layout.js"></script>



  <main class="wrap">
    <h1>Ø§Ù„Ø¯ÙØ¹</h1>

    <!-- Empty Cart State -->
    <div id="emptyCart" class="card" style="display: none; text-align: center; padding: 60px 20px;">
      <div style="font-size: 48px; margin-bottom: 20px;">ğŸ›’</div>
      <h2 style="margin-bottom: 12px;">Ø³Ù„Ø© Ø§Ù„ØªØ³ÙˆÙ‚ ÙØ§Ø±ØºØ©</h2>
      <p class="muted" style="margin-bottom: 24px;">Ø£Ø¶Ù Ø¨Ø¹Ø¶ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù„Ù„Ø¯ÙØ¹</p>
      <a href="shop.html" class="btn">Ù…ÙˆØ§ØµÙ„Ø© Ø§Ù„ØªØ³ÙˆÙ‚</a>
    </div>

    <!-- Checkout Form -->
    <div id="checkoutForm" style="display: none;">
      <div class="grid" style="grid-template-columns: 2fr 1fr; gap: 24px;">

        <!-- Left Column: Customer Information -->
        <div>
          <div class="card">
            <h3>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø´Ø­Ù†</h3>

            <div class="form-group">
              <label for="fullName">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„ *</label>
              <input type="text" id="fullName" required placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„">
            </div>

            <div class="form-group">
              <label for="phone">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ *</label>
              <input type="tel" id="phone" required placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ">
            </div>

            <div class="form-group">
              <label for="address">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø´Ø­Ù† *</label>
              <textarea id="address" required placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙƒØ§Ù…Ù„" rows="3"></textarea>
            </div>

            <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 12px;">
              <div class="form-group">
                <label for="city">Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© *</label>
                <input type="text" id="city" required placeholder="Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©">
              </div>
              <div class="form-group">
                <label for="area">Ø§Ù„Ù…Ù†Ø·Ù‚Ø© *</label>
                <input type="text" id="area" required placeholder="Ø§Ù„Ù…Ù†Ø·Ù‚Ø©">
              </div>
            </div>

            <div class="form-group">
              <label for="notes">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø·Ù„Ø¨ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
              <textarea id="notes" placeholder="Ø£ÙŠ ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø®Ø§ØµØ© Ù„Ù„ØªÙˆØµÙŠÙ„" rows="2"></textarea>
            </div>
          </div>

          <div class="card">
            <h3>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</h3>

            <div class="payment-methods">
              <label class="payment-option">
                <input type="radio" name="payment" value="cash" checked>
                <div class="payment-content">
                  <div style="font-weight: 600;">Ø§Ù„Ø¯ÙØ¹ Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…</div>
                  <div class="muted" style="font-size: 14px;">Ø§Ø¯ÙØ¹ Ø¹Ù†Ø¯ Ø§Ø³ØªÙ„Ø§Ù… Ø·Ù„Ø¨Ùƒ</div>
                </div>
              </label>

            </div>

          </div>
        </div>

        <!-- Right Column: Order Summary -->
        <div>
          <div class="card">
            <h3>Ù…Ù„Ø®Øµ Ø§Ù„Ø·Ù„Ø¨</h3>

            <div id="checkoutItems">
              <!-- Ø³ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø³Ù„Ø© Ù‡Ù†Ø§ -->
            </div>

            <div style="border-top: 1px solid var(--w1); padding-top: 16px;">
              <div class="row between" style="margin-bottom: 8px;">
                <div class="muted">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙØ±Ø¹ÙŠ</div>
                <div id="checkoutSubtotal">Ø¯ÙŠÙ†Ø§Ø± 0</div>
              </div>
              <div class="row between" style="margin-bottom: 8px;">
                <div class="muted">Ø§Ù„Ø´Ø­Ù†</div>
                <div id="checkoutShipping">Ø¯ÙŠÙ†Ø§Ø± 5,000</div>
              </div>
              <div class="row between" style="margin-bottom: 12px;">
                <div class="muted">Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©</div>
                <div id="checkoutTax">Ø¯ÙŠÙ†Ø§Ø± 0</div>
              </div>
              <div class="row between" style="padding-top: 12px; border-top: 1px solid var(--w1); font-weight: 600;">
                <div>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</div>
                <div id="checkoutTotal" style="color: var(--red);">Ø¯ÙŠÙ†Ø§Ø± 0</div>
              </div>
            </div>

            <button class="btn" style="width: 100%; margin-top: 20px;" id="placeOrderBtn">
              ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨
            </button>

            <a href="cart.html" class="btn secondary" style="width: 100%; margin-top: 8px; text-align: center; display: block; text-decoration: none;">
              Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø³Ù„Ø©
            </a>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script>
  // Language switching
  document.getElementById('langSwitch').addEventListener('click', function() {
    window.location.href = '../checkout.html';
  });

  class CheckoutPage {
      constructor() {
          this.cart = null;
          this.init();
      }

      async init() {
          console.log('ğŸ›’ ØªÙ‡ÙŠØ¦Ø© ØµÙØ­Ø© Ø§Ù„Ø¯ÙØ¹...');
          await this.loadCart();
          this.setupEventListeners();
          this.updateCartCount();
      }

      async loadCart() {
          try {
              // Wait for API to be available
              if (typeof alsajiAPI === 'undefined') {
                  console.log('Ø¬Ø§Ø±ÙŠ Ø§Ù†ØªØ¸Ø§Ø± API...');
                  setTimeout(() => this.loadCart(), 100);
                  return;
              }

              const cartResult = await alsajiAPI.getCart();
              if (cartResult.success && cartResult.cart.items.length > 0) {
                  this.cart = cartResult.cart;
                  this.showCheckoutForm();
                  this.renderOrderSummary();
              } else {
                  this.showEmptyCart();
              }
          } catch (error) {
              console.error('ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ù„Ø©:', error);
              this.showEmptyCart();
          }
      }

      showCheckoutForm() {
          document.getElementById('emptyCart').style.display = 'none';
          document.getElementById('checkoutForm').style.display = 'block';
      }

      showEmptyCart() {
          document.getElementById('emptyCart').style.display = 'block';
          document.getElementById('checkoutForm').style.display = 'none';
      }

      renderOrderSummary() {
          if (!this.cart) return;

          const itemsContainer = document.getElementById('checkoutItems');
          itemsContainer.innerHTML = this.cart.items.map(item => `
              <div class="checkout-item">
                  <div class="checkout-item-image">
                      ${item.image ?
                          `<img src="${item.image}" alt="${item.name}">` :
                          '<div class="muted" style="font-size:12px">Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ±Ø©</div>'
                      }
                  </div>
                  <div class="checkout-item-details">
                      <div class="checkout-item-name">${this.escapeHtml(item.name)}</div>
                      <div class="checkout-item-quantity">Ø§Ù„ÙƒÙ…ÙŠØ©: ${item.quantity}</div>
                  </div>
                  <div class="checkout-item-price">Ø¯ÙŠÙ†Ø§Ø± ${(item.subtotal || 0).toLocaleString()}</div>
              </div>
          `).join('');

          this.updateTotals();
      }

      updateTotals() {
          if (!this.cart) return;

          const subtotal = this.cart.total || 0;
          const shipping = 5000; // Fixed shipping cost
          const tax = Math.round(subtotal * 0.05); // 5% tax
          const total = subtotal + shipping + tax;

          document.getElementById('checkoutSubtotal').textContent = `Ø¯ÙŠÙ†Ø§Ø± ${subtotal.toLocaleString()}`;
          document.getElementById('checkoutShipping').textContent = `Ø¯ÙŠÙ†Ø§Ø± ${shipping.toLocaleString()}`;
          document.getElementById('checkoutTax').textContent = `Ø¯ÙŠÙ†Ø§Ø± ${tax.toLocaleString()}`;
          document.getElementById('checkoutTotal').textContent = `Ø¯ÙŠÙ†Ø§Ø± ${total.toLocaleString()}`;
      }

      setupEventListeners() {
          // Payment method changes
          document.querySelectorAll('input[name="payment"]').forEach(radio => {
              radio.addEventListener('change', (e) => {
                  this.toggleCardFields(e.target.value === 'card');
              });
          });

          // Place order button
          document.getElementById('placeOrderBtn').addEventListener('click', () => {
              this.placeOrder();
          });

          // Update cart count
          this.updateCartCount();
      }

      toggleCardFields(show) {
          const cardFields = document.getElementById('cardFields');
          if (cardFields) {
              cardFields.style.display = show ? 'block' : 'none';

              // Toggle required attribute for card fields
              const cardInputs = cardFields.querySelectorAll('input');
              cardInputs.forEach(input => {
                  input.required = show;
              });
          }
      }

  async placeOrder() {
      try {
          // Validate form
          if (!this.validateForm()) {
              return;
          }

          // Get form data
          const formData = this.getFormData();
          const orderNumber = 'ALS' + Date.now().toString().slice(-8);

          // Show loading state
          const btn = document.getElementById('placeOrderBtn');
          const originalText = btn.textContent;
          btn.textContent = 'Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø·Ù„Ø¨...';
          btn.disabled = true;

        // Process order (NO CUSTOM ORDER NUMBER)
        const orderResult = await this.processOrder(formData);

        if (orderResult.success) {
            // Clear cart
            await alsajiAPI.clearCart();

            // Redirect to confirmation page
            const totalAmount = this.cart.total + 5000 + Math.round(this.cart.total * 0.05);
            const urlParams = new URLSearchParams({
                order: orderResult.odoo_order_number, // ğŸ”¥ USE ODOO ORDER NUMBER
                total: totalAmount,
                odoo_id: orderResult.odoo_order_id || 'manual'
            });

            window.location.href = `order-confirmed.html?${urlParams.toString()}`;
        } else {
            throw new Error(orderResult.error);
        }

    } catch (error) {
        console.error('ÙØ´Ù„ Ø§Ù„Ø·Ù„Ø¨:', error);
        alert('ÙØ´Ù„ ÙÙŠ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨: ' + error.message);

        // Reset button
        const btn = document.getElementById('placeOrderBtn');
        btn.textContent = 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨';
        btn.disabled = false;
    }
}

  getFormData() {
    // ğŸ”¥ FIX: Check if elements exist before accessing their values
    const fullNameEl = document.getElementById('fullName');
    const phoneEl = document.getElementById('phone');
    const addressEl = document.getElementById('address');
    const cityEl = document.getElementById('city');
    const areaEl = document.getElementById('area');

    if (!fullNameEl || !phoneEl || !addressEl || !cityEl || !areaEl) {
        throw new Error('Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ù…ÙÙ‚ÙˆØ¯Ø©');
    }

    return {
        customer: {
            fullName: fullNameEl.value,
            email: '', // ğŸ”¥ ADD DEFAULT EMAIL SINCE FIELD DOESN'T EXIST
            phone: phoneEl.value,
            address: addressEl.value,
            city: cityEl.value,
            area: areaEl.value,
            notes: document.getElementById('notes')?.value || ''
        },
        payment: 'cash', // ğŸ”¥ ALWAYS CASH
        order: this.cart,
        timestamp: new Date().toISOString()
    };
}

validateForm() {
    const requiredFields = ['fullName', 'phone', 'address', 'city', 'area'];
    let isValid = true;

    requiredFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (!field || !field.value.trim()) {
            if (field) field.style.borderColor = 'var(--red)';
            isValid = false;
        } else {
            field.style.borderColor = '';
        }
    });

    if (!isValid) {
        alert('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­.');
    }

    return isValid;
}

// In checkout.html - update the processOrder method
async processOrder(formData) {
    // Prepare order data for Odoo
    const orderData = {
        customer: formData.customer,
        payment: formData.payment,
        items: this.cart.items.map(item => ({
            product_id: item.product_id,
            name: item.name,
            quantity: item.quantity,
            unit_price: item.unit_price,
            subtotal: item.subtotal
        })),
        total: this.cart.total,
        shipping: 5000,
        tax: Math.round(this.cart.total * 0.05),
        timestamp: formData.timestamp
    };

    try {
        // Send order to Odoo
        const odooResult = await alsajiAPI.createOdooOrder(orderData);

        if (odooResult.success) {
            console.log('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø·Ù„Ø¨ ÙÙŠ Odoo:', odooResult.odoo_order_id);
            return {
                success: true,
                odoo_order_id: odooResult.odoo_order_id,
                odoo_order_number: odooResult.odoo_order_number, // ğŸ”¥ RETURN ODOO NUMBER
                message: 'ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­ ÙÙŠ Odoo'
            };
        } else {
            throw new Error(odooResult.error || 'ÙØ´Ù„ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø·Ù„Ø¨ ÙÙŠ Odoo');
        }

    } catch (error) {
        console.error('âŒ ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø·Ù„Ø¨ Odoo:', error);

        // Fallback: Save order for manual processing
        // ğŸ”¥ Generate a simple timestamp-based reference for fallback
        const fallbackRef = 'WEB-' + Date.now().toString().slice(-6);
        this.saveOrderForManualProcessing({
            ...orderData,
            fallback_reference: fallbackRef
        });

        return {
            success: true,
            fallback: true,
            odoo_order_number: fallbackRef, // ğŸ”¥ USE FALLBACK REFERENCE
            message: 'ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø·Ù„Ø¨ Ù„Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ÙŠØ¯ÙˆÙŠØ© (Odoo ØºÙŠØ± Ù…ØªØ§Ø­)'
        };
    }
}

  saveOrderForManualProcessing(orderData) {
      try {
          let pendingOrders = JSON.parse(localStorage.getItem('alsaji_pending_orders') || '[]');
          pendingOrders.push({
              ...orderData,
              created_at: new Date().toISOString(),
              status: 'pending'
          });
          localStorage.setItem('alsaji_pending_orders', JSON.stringify(pendingOrders));
          console.log('ğŸ“‹ ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø·Ù„Ø¨ Ù„Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ÙŠØ¯ÙˆÙŠØ©');
      } catch (error) {
          console.error('ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø·Ù„Ø¨ Ù„Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ÙŠØ¯ÙˆÙŠØ©:', error);
      }
  }

      async updateCartCount() {
          try {
              if (typeof alsajiAPI === 'undefined') return;

              const cartResult = await alsajiAPI.getCart();
              const count = cartResult.cart.item_count || 0;

              const cartCountElement = document.getElementById('cartCount');
              if (cartCountElement) {
                  cartCountElement.textContent = count;
              }
          } catch (error) {
              console.error('ÙØ´Ù„ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù†Ø§ØµØ±:', error);
          }
      }

      escapeHtml(text) {
          if (!text) return '';
          const div = document.createElement('div');
          div.textContent = text;
          return div.innerHTML;
      }
  }

  // Initialize checkout page
  document.addEventListener('DOMContentLoaded', () => {
      window.checkoutPage = new CheckoutPage();
  });

    // In your main app.js or wherever you initialize the API
document.addEventListener('DOMContentLoaded', function() {
    // Set Odoo credentials
    alsajiAPI.setCredentials('mntr59@gmail.com', '0212');

    // This will automatically authenticate when needed
    alsajiAPI.ensureAuthenticated().then(authenticated => {
        if (authenticated) {
            console.log('âœ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù†Ø§Ø¬Ø­');
        } else {
            console.error('âŒ ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ');
        }
    });
});
  </script>

</body>
</html>