<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Checkout - AlSaji Auto Parts</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <script src="data/static_api.js"></script>
  <script src="js/api.js"></script>
  <script src="js/cart-manager.js"></script>

  <header class="util">
    <div class="wrap row between">
      <div class="row" style="gap:12px"></div>
      <div class="row" style="gap:12px">
        <button class="chip" id="langBtn">AR</button>
        <a class="chip" href="account.html">Account</a>
        <a class="chip" href="cart.html">üõí <span id="cartCount">0</span></a>
      </div>
    </div>
    <nav class="nav">
      <div class="wrap row">
        <a class="tab" href="index.html">Home</a>
        <a class="tab" href="shop.html">Shop</a>
        <a class="tab" href="services.html">Services</a>
        <a class="tab" href="brands.html">Brands & Partners</a>
        <a class="tab" href="branches.html">Branches</a>
        <a class="tab" href="news.html">News & Guides</a>
        <a class="tab" href="support.html">Support</a>
        <a class="tab" href="trade.html">Trade Portal</a>
      </div>
    </nav>
  </header>

  <main class="wrap">
    <h1>Checkout</h1>

    <!-- Empty Cart State -->
    <div id="emptyCart" class="card" style="display: none; text-align: center; padding: 60px 20px;">
      <div style="font-size: 48px; margin-bottom: 20px;">üõí</div>
      <h2 style="margin-bottom: 12px;">Your cart is empty</h2>
      <p class="muted" style="margin-bottom: 24px;">Add some products to checkout</p>
      <a href="shop.html" class="btn">Continue Shopping</a>
    </div>

    <!-- Checkout Form -->
    <div id="checkoutForm" style="display: none;">
      <div class="grid" style="grid-template-columns: 2fr 1fr; gap: 24px;">

        <!-- Left Column: Customer Information -->
        <div>
          <div class="card">
            <h3>Shipping Information</h3>

            <div class="form-group">
              <label for="fullName">Full Name *</label>
              <input type="text" id="fullName" required placeholder="Enter your full name">
            </div>

            <div class="form-group">
              <label for="email">Email Address *</label>
              <input type="email" id="email" required placeholder="Enter your email">
            </div>

            <div class="form-group">
              <label for="phone">Phone Number *</label>
              <input type="tel" id="phone" required placeholder="Enter your phone number">
            </div>

            <div class="form-group">
              <label for="address">Shipping Address *</label>
              <textarea id="address" required placeholder="Enter your complete address" rows="3"></textarea>
            </div>

            <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 12px;">
              <div class="form-group">
                <label for="city">City *</label>
                <input type="text" id="city" required placeholder="City">
              </div>
              <div class="form-group">
                <label for="area">Area *</label>
                <input type="text" id="area" required placeholder="Area">
              </div>
            </div>

            <div class="form-group">
              <label for="notes">Order Notes (Optional)</label>
              <textarea id="notes" placeholder="Any special instructions for delivery" rows="2"></textarea>
            </div>
          </div>

          <div class="card">
            <h3>Payment Method</h3>

            <div class="payment-methods">
              <label class="payment-option">
                <input type="radio" name="payment" value="cash" checked>
                <div class="payment-content">
                  <div style="font-weight: 600;">Cash on Delivery</div>
                  <div class="muted" style="font-size: 14px;">Pay when you receive your order</div>
                </div>
              </label>

              <label class="payment-option">
                <input type="radio" name="payment" value="card">
                <div class="payment-content">
                  <div style="font-weight: 600;">Credit/Debit Card</div>
                  <div class="muted" style="font-size: 14px;">Pay securely with your card</div>
                </div>
              </label>

              <label class="payment-option">
                <input type="radio" name="payment" value="transfer">
                <div class="payment-content">
                  <div style="font-weight: 600;">Bank Transfer</div>
                  <div class="muted" style="font-size: 14px;">Transfer money to our bank account</div>
                </div>
              </label>
            </div>

            <!-- Card Payment Fields (Hidden by default) -->
            <div id="cardFields" style="display: none; margin-top: 16px; padding: 16px; background: var(--w2); border-radius: 8px;">
              <div class="form-group">
                <label for="cardNumber">Card Number</label>
                <input type="text" id="cardNumber" placeholder="1234 5678 9012 3456">
              </div>
              <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 12px;">
                <div class="form-group">
                  <label for="expiry">Expiry Date</label>
                  <input type="text" id="expiry" placeholder="MM/YY">
                </div>
                <div class="form-group">
                  <label for="cvv">CVV</label>
                  <input type="text" id="cvv" placeholder="123">
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Right Column: Order Summary -->
        <div>
          <div class="card">
            <h3>Order Summary</h3>

            <div id="checkoutItems">
              <!-- Cart items will be loaded here -->
            </div>

            <div style="border-top: 1px solid var(--w1); padding-top: 16px;">
              <div class="row between" style="margin-bottom: 8px;">
                <div class="muted">Subtotal</div>
                <div id="checkoutSubtotal">IQD 0</div>
              </div>
              <div class="row between" style="margin-bottom: 8px;">
                <div class="muted">Shipping</div>
                <div id="checkoutShipping">IQD 5,000</div>
              </div>
              <div class="row between" style="margin-bottom: 12px;">
                <div class="muted">Tax</div>
                <div id="checkoutTax">IQD 0</div>
              </div>
              <div class="row between" style="padding-top: 12px; border-top: 1px solid var(--w1); font-weight: 600;">
                <div>Total</div>
                <div id="checkoutTotal" style="color: var(--red);">IQD 0</div>
              </div>
            </div>

            <button class="btn" style="width: 100%; margin-top: 20px;" id="placeOrderBtn">
              Place Order
            </button>

            <a href="cart.html" class="btn secondary" style="width: 100%; margin-top: 8px; text-align: center; display: block; text-decoration: none;">
              Back to Cart
            </a>
          </div>
        </div>
      </div>
    </div>
  </main>

  <style>
    .form-group {
      margin-bottom: 16px;
    }

    .form-group label {
      display: block;
      margin-bottom: 6px;
      font-weight: 500;
      color: var(--text);
    }

    .form-group input,
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 12px;
      border: 1px solid var(--w3);
      border-radius: 6px;
      font-size: 14px;
      transition: border-color 0.2s;
    }

    .form-group input:focus,
    .form-group textarea:focus,
    .form-group select:focus {
      outline: none;
      border-color: var(--primary);
    }

    .payment-methods {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .payment-option {
      display: flex;
      align-items: center;
      padding: 12px;
      border: 1px solid var(--w3);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .payment-option:hover {
      border-color: var(--primary);
    }

    .payment-option input[type="radio"] {
      margin-right: 12px;
    }

    .payment-content {
      flex: 1;
    }

    .checkout-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 0;
      border-bottom: 1px solid var(--w1);
    }

    .checkout-item:last-child {
      border-bottom: none;
    }

    .checkout-item-image {
      width: 60px;
      height: 60px;
      background: var(--w2);
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .checkout-item-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 6px;
    }

    .checkout-item-details {
      flex: 1;
    }

    .checkout-item-name {
      font-weight: 500;
      margin-bottom: 4px;
    }

    .checkout-item-price {
      color: var(--red);
      font-weight: 600;
    }

    .checkout-item-quantity {
      color: var(--muted);
      font-size: 14px;
    }
  </style>

  <script>
  class CheckoutPage {
      constructor() {
          this.cart = null;
          this.init();
      }

      async init() {
          console.log('üõí Initializing checkout page...');
          await this.loadCart();
          this.setupEventListeners();
          this.updateCartCount();
      }

      async loadCart() {
          try {
              // Wait for API to be available
              if (typeof alsajiAPI === 'undefined') {
                  console.log('Waiting for API...');
                  setTimeout(() => this.loadCart(), 100);
                  return;
              }

              const cartResult = await alsajiAPI.getCart();
              if (cartResult.success && cartResult.cart.items.length > 0) {
                  this.cart = cartResult.cart;
                  this.showCheckoutForm();
                  this.renderOrderSummary();
              } else {
                  this.showEmptyCart();
              }
          } catch (error) {
              console.error('Failed to load cart:', error);
              this.showEmptyCart();
          }
      }

      showCheckoutForm() {
          document.getElementById('emptyCart').style.display = 'none';
          document.getElementById('checkoutForm').style.display = 'block';
      }

      showEmptyCart() {
          document.getElementById('emptyCart').style.display = 'block';
          document.getElementById('checkoutForm').style.display = 'none';
      }

      renderOrderSummary() {
          if (!this.cart) return;

          const itemsContainer = document.getElementById('checkoutItems');
          itemsContainer.innerHTML = this.cart.items.map(item => `
              <div class="checkout-item">
                  <div class="checkout-item-image">
                      ${item.image ?
                          `<img src="${item.image}" alt="${item.name}">` :
                          '<div class="muted" style="font-size:12px">No Image</div>'
                      }
                  </div>
                  <div class="checkout-item-details">
                      <div class="checkout-item-name">${this.escapeHtml(item.name)}</div>
                      <div class="checkout-item-quantity">Qty: ${item.quantity}</div>
                  </div>
                  <div class="checkout-item-price">IQD ${(item.subtotal || 0).toLocaleString()}</div>
              </div>
          `).join('');

          this.updateTotals();
      }

      updateTotals() {
          if (!this.cart) return;

          const subtotal = this.cart.total || 0;
          const shipping = 5000; // Fixed shipping cost
          const tax = Math.round(subtotal * 0.05); // 5% tax
          const total = subtotal + shipping + tax;

          document.getElementById('checkoutSubtotal').textContent = `IQD ${subtotal.toLocaleString()}`;
          document.getElementById('checkoutShipping').textContent = `IQD ${shipping.toLocaleString()}`;
          document.getElementById('checkoutTax').textContent = `IQD ${tax.toLocaleString()}`;
          document.getElementById('checkoutTotal').textContent = `IQD ${total.toLocaleString()}`;
      }

      setupEventListeners() {
          // Payment method changes
          document.querySelectorAll('input[name="payment"]').forEach(radio => {
              radio.addEventListener('change', (e) => {
                  this.toggleCardFields(e.target.value === 'card');
              });
          });

          // Place order button
          document.getElementById('placeOrderBtn').addEventListener('click', () => {
              this.placeOrder();
          });

          // Update cart count
          this.updateCartCount();
      }

      toggleCardFields(show) {
          const cardFields = document.getElementById('cardFields');
          cardFields.style.display = show ? 'block' : 'none';

          // Toggle required attribute for card fields
          const cardInputs = cardFields.querySelectorAll('input');
          cardInputs.forEach(input => {
              input.required = show;
          });
      }

  async placeOrder() {
      try {
          // Validate form
          if (!this.validateForm()) {
              return;
          }

          // Get form data
          const formData = this.getFormData();
          const orderNumber = 'ALS' + Date.now().toString().slice(-8);

          // Show loading state
          const btn = document.getElementById('placeOrderBtn');
          const originalText = btn.textContent;
          btn.textContent = 'Creating Order...';
          btn.disabled = true;

          // Process order (this now sends to Odoo)
          const orderResult = await this.processOrder({
              ...formData,
              order_number: orderNumber
          });

          if (orderResult.success) {
              // Clear cart
              await alsajiAPI.clearCart();

              // Redirect to confirmation page
              const totalAmount = this.cart.total + 5000 + Math.round(this.cart.total * 0.05);
              const urlParams = new URLSearchParams({
                  order: orderNumber,
                  total: totalAmount,
                  odoo_id: orderResult.odoo_order_id || 'manual'
              });

              window.location.href = `order-confirmed.html?${urlParams.toString()}`;
          } else {
              throw new Error(orderResult.error);
          }

      } catch (error) {
          console.error('Order failed:', error);
          alert('Failed to place order: ' + error.message);

          // Reset button
          const btn = document.getElementById('placeOrderBtn');
          btn.textContent = 'Place Order';
          btn.disabled = false;
      }
  }
      validateForm() {
          const requiredFields = ['fullName', 'email', 'phone', 'address', 'city', 'area'];
          let isValid = true;

          requiredFields.forEach(fieldId => {
              const field = document.getElementById(fieldId);
              if (!field.value.trim()) {
                  field.style.borderColor = 'var(--red)';
                  isValid = false;
              } else {
                  field.style.borderColor = '';
              }
          });

          // Email validation
          const email = document.getElementById('email');
          const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
          if (email.value && !emailRegex.test(email.value)) {
              email.style.borderColor = 'var(--red)';
              isValid = false;
              alert('Please enter a valid email address');
          }

          if (!isValid) {
              alert('Please fill in all required fields correctly.');
          }

          return isValid;
      }

      getFormData() {
          const paymentMethod = document.querySelector('input[name="payment"]:checked').value;

          return {
              customer: {
                  fullName: document.getElementById('fullName').value,
                  email: document.getElementById('email').value,
                  phone: document.getElementById('phone').value,
                  address: document.getElementById('address').value,
                  city: document.getElementById('city').value,
                  area: document.getElementById('area').value,
                  notes: document.getElementById('notes').value
              },
              payment: paymentMethod,
              cardDetails: paymentMethod === 'card' ? {
                  cardNumber: document.getElementById('cardNumber').value,
                  expiry: document.getElementById('expiry').value,
                  cvv: document.getElementById('cvv').value
              } : null,
              order: this.cart,
              timestamp: new Date().toISOString()
          };
      }

  async processOrder(formData) {
      // Prepare order data for Odoo
      const orderData = {
          order_number: formData.order_number || 'ALS' + Date.now().toString().slice(-8),
          customer: formData.customer,
          payment: formData.payment,
          items: this.cart.items.map(item => ({
              product_id: item.product_id,
              name: item.name,
              quantity: item.quantity,
              unit_price: item.unit_price,
              subtotal: item.subtotal
          })),
          total: this.cart.total,
          shipping: 5000,
          tax: Math.round(this.cart.total * 0.05),
          timestamp: formData.timestamp
      };

      try {
          // Send order to Odoo
          const odooResult = await alsajiAPI.createOdooOrder(orderData);

          if (odooResult.success) {
              console.log('‚úÖ Order created in Odoo:', odooResult.odoo_order_id);
              return {
                  success: true,
                  odoo_order_id: odooResult.odoo_order_id,
                  message: 'Order created successfully in Odoo'
              };
          } else {
              throw new Error(odooResult.error || 'Failed to create order in Odoo');
          }

      } catch (error) {
          console.error('‚ùå Odoo order creation failed:', error);

          // Fallback: Save order for manual processing
          this.saveOrderForManualProcessing(orderData);

          return {
              success: true,
              fallback: true,
              message: 'Order saved for manual processing (Odoo unavailable)'
          };
      }
  }

  saveOrderForManualProcessing(orderData) {
      try {
          let pendingOrders = JSON.parse(localStorage.getItem('alsaji_pending_orders') || '[]');
          pendingOrders.push({
              ...orderData,
              created_at: new Date().toISOString(),
              status: 'pending'
          });
          localStorage.setItem('alsaji_pending_orders', JSON.stringify(pendingOrders));
          console.log('üìã Order saved for manual processing');
      } catch (error) {
          console.error('Failed to save order for manual processing:', error);
      }
  }

      async updateCartCount() {
          try {
              if (typeof alsajiAPI === 'undefined') return;

              const cartResult = await alsajiAPI.getCart();
              const count = cartResult.cart.item_count || 0;

              const cartCountElement = document.getElementById('cartCount');
              if (cartCountElement) {
                  cartCountElement.textContent = count;
              }
          } catch (error) {
              console.error('Failed to update cart count:', error);
          }
      }

      escapeHtml(text) {
          if (!text) return '';
          const div = document.createElement('div');
          div.textContent = text;
          return div.innerHTML;
      }
  }

  // Initialize checkout page
  document.addEventListener('DOMContentLoaded', () => {
      window.checkoutPage = new CheckoutPage();
  });

    // In your main app.js or wherever you initialize the API
document.addEventListener('DOMContentLoaded', function() {
    // Set Odoo credentials
    alsajiAPI.setCredentials('mntr59@gmail.com', '0212');

    // This will automatically authenticate when needed
    alsajiAPI.ensureAuthenticated().then(authenticated => {
        if (authenticated) {
            console.log('‚úÖ Auto-login successful');
        } else {
            console.error('‚ùå Auto-login failed');
        }
    });
});
  </script>

</body>
</html>