<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Checkout - AlSaji Auto Parts</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <header class="util">
    <div class="wrap row between">
      <div class="row" style="gap:12px">
        <span style="color:var(--navy1);font-size:14px">Branch</span>
        <div class="relative">
          <button class="chip" id="branchBtn">Baghdad - Palestine St.</button>
        </div>
      </div>
      <div class="row" style="gap:12px">
        <div class="search">
          <span>ðŸ”Ž</span>
          <input id="searchInput" placeholder="Search by OE, name, or brand">
        </div>
        <button class="chip" id="langBtn">AR</button>
        <a class="chip" href="account.html">Account</a>
        <a class="chip" href="cart.html">ðŸ›’ <span id="cartCount">0</span></a>
      </div>
    </div>
    <nav class="nav">
      <div class="wrap row">
        <a class="tab" href="index.html">Home</a>
        <a class="tab" href="shop.html">Shop</a>
        <a class="tab" href="services.html">Services</a>
        <a class="tab" href="brands.html">Brands & Partners</a>
        <a class="tab" href="news.html">News & Guides</a>
        <a class="tab" href="branches.html">Branches</a>
        <a class="tab" href="support.html">Support</a>
        <a class="tab" href="account.html">Account</a>
        <a class="tab" href="trade.html">Trade Portal</a>
        <span style="margin-left:auto" class="muted">Live Chat available</span>
      </div>
    </nav>
  </header>

  <main class="wrap">
    <div class="grid" style="grid-template-columns:2fr 1fr;gap:24px;align-items:start">
      <!-- Checkout Form -->
      <div>
        <h1>Checkout</h1>

        <!-- Customer Information -->
        <div class="card">
          <h3>Customer Information</h3>
          <div class="grid" style="grid-template-columns:1fr 1fr;gap:12px">
            <div>
              <label>First Name *</label>
              <input type="text" id="firstName" placeholder="First Name" required>
            </div>
            <div>
              <label>Last Name *</label>
              <input type="text" id="lastName" placeholder="Last Name" required>
            </div>
            <div style="grid-column:span 2">
              <label>Email *</label>
              <input type="email" id="email" placeholder="email@example.com" required>
            </div>
            <div style="grid-column:span 2">
              <label>Phone Number *</label>
              <input type="tel" id="phone" placeholder="+964 XXX XXX XXXX" required>
            </div>
          </div>
        </div>

        <!-- Shipping Address -->
        <div class="card">
          <h3>Shipping Address</h3>
          <div class="grid" style="grid-template-columns:1fr 1fr;gap:12px">
            <div style="grid-column:span 2">
              <label>Address *</label>
              <input type="text" id="address" placeholder="Street Address" required>
            </div>
            <div>
              <label>City *</label>
              <input type="text" id="city" placeholder="City" required>
            </div>
            <div>
              <label>Region *</label>
              <select id="region" required>
                <option value="">Select Region</option>
                <option value="baghdad">Baghdad</option>
                <option value="basra">Basra</option>
                <option value="erbil">Erbil</option>
                <option value="sulaymaniyah">Sulaymaniyah</option>
                <option value="mosul">Mosul</option>
                <option value="kirkuk">Kirkuk</option>
                <option value="other">Other</option>
              </select>
            </div>
            <div>
              <label>Additional Info</label>
              <input type="text" id="additionalInfo" placeholder="Apartment, suite, etc.">
            </div>
          </div>
        </div>

        <!-- Payment Method -->
        <div class="card">
          <h3>Payment Method</h3>
          <div class="radio-group">
            <label class="radio">
              <input type="radio" name="payment" value="cash" checked>
              <span>Cash on Delivery</span>
            </label>
            <label class="radio">
              <input type="radio" name="payment" value="card">
              <span>Credit/Debit Card</span>
            </label>
            <label class="radio">
              <input type="radio" name="payment" value="transfer">
              <span>Bank Transfer</span>
            </label>
          </div>
        </div>

        <!-- Card Details (Hidden by default) -->
        <div class="card" id="cardDetails" style="display:none">
          <h3>Card Details</h3>
          <div class="grid" style="grid-template-columns:1fr 1fr;gap:12px">
            <div style="grid-column:span 2">
              <label>Card Number</label>
              <input type="text" id="cardNumber" placeholder="1234 5678 9012 3456">
            </div>
            <div>
              <label>Expiry Date</label>
              <input type="text" id="expiryDate" placeholder="MM/YY">
            </div>
            <div>
              <label>CVV</label>
              <input type="text" id="cvv" placeholder="123">
            </div>
            <div style="grid-column:span 2">
              <label>Cardholder Name</label>
              <input type="text" id="cardholderName" placeholder="Full Name">
            </div>
          </div>
        </div>
      </div>

      <!-- Order Summary -->
      <div>
        <div class="card sticky" style="top:100px">
          <h3>Order Summary</h3>
          <div id="checkoutItems">
            <!-- Cart items will be loaded here -->
          </div>
          <div style="margin-top:16px;padding-top:16px;border-top:1px solid var(--w1)">

            <div class="row between" style="margin:8px 0">
              <div class="muted">Subtotal</div>
              <div id="checkoutSubtotal">IQD 0</div>
            </div>
            <div class="row between" style="margin:8px 0">
              <div class="muted">Shipping</div>
              <div id="checkoutShipping">IQD 5,000</div>
            </div>
            <div class="row between" style="margin:12px 0;padding-top:12px;border-top:1px solid var(--w1)">
              <div style="font-weight:600">Total</div>
              <div id="checkoutTotal" style="font-weight:600;color:var(--red)">IQD 0</div>
            </div>
          </div>
          <button class="btn" style="width:100%;margin-top:16px" id="placeOrderBtn">
            Place Order
          </button>
          <a href="cart.html" class="btn secondary" style="width:100%;margin-top:8px;text-align:center;display:block;text-decoration:none">
            Back to Cart
          </a>
        </div>
      </div>
    </div>
  </main>

  <script src="js/api.js"></script>
  <script>
    class CheckoutManager {
      constructor() {
        this.api = new AlSajiAPI();
        this.cartData = null;
        this.init();
      }

      async init() {
        await this.loadCart();
        this.setupEventListeners();
        this.updateCartCount();
      }

      async loadCart() {
        try {
          const result = await this.api.getCart();
          if (result.success && result.cart.lines.length > 0) {
            this.cartData = result.cart;
            this.renderCheckoutItems();
            this.updateTotals();
          } else {
            this.showEmptyCart();
          }
        } catch (error) {
          console.error('Error loading cart:', error);
          this.showEmptyCart();
        }
      }

      renderCheckoutItems() {
        const container = document.getElementById('checkoutItems');
        container.innerHTML = '';

        this.cartData.lines.forEach(item => {
          const itemElement = document.createElement('div');
          itemElement.className = 'row between';
          itemElement.style.cssText = 'padding:8px 0;border-bottom:1px solid var(--w1);align-items:center';

          itemElement.innerHTML = `
            <div style="flex:1">
              <div style="font-weight:500;font-size:14px">${this.escapeHtml(item.product_name)}</div>
              <div class="muted" style="font-size:12px">Qty: ${item.quantity}</div>
            </div>
            <div style="font-weight:600;font-size:14px">IQD ${this.formatPrice(item.total)}</div>
          `;

          container.appendChild(itemElement);
        });
      }

      updateTotals() {
        if (!this.cartData) return;

        const subtotal = this.cartData.total_amount || 0;
        const shipping = 5000;
        const total = subtotal + shipping;

        document.getElementById('checkoutSubtotal').textContent = `IQD ${this.formatPrice(subtotal)}`;
        document.getElementById('checkoutTotal').textContent = `IQD ${this.formatPrice(total)}`;
      }

      updateCartCount() {
        const count = this.cartData ? this.cartData.cart_count : 0;
        document.getElementById('cartCount').textContent = count;
      }

      showEmptyCart() {
        alert('Your cart is empty! Please add some items before checkout.');
        window.location.href = 'shop.html';
      }

      setupEventListeners() {
        // Payment method toggle
        document.querySelectorAll('input[name="payment"]').forEach(radio => {
          radio.addEventListener('change', (e) => {
            const cardDetails = document.getElementById('cardDetails');
            cardDetails.style.display = e.target.value === 'card' ? 'block' : 'none';
          });
        });

        // Place order button
        document.getElementById('placeOrderBtn').addEventListener('click', () => {
          this.placeOrder();
        });
      }

      async placeOrder() {
        // Validate form
        if (!this.validateForm()) {
          return;
        }

        const orderData = this.collectOrderData();

        try {
          // Show loading state
          const btn = document.getElementById('placeOrderBtn');
          btn.disabled = true;
          btn.textContent = 'Processing...';

          // Process order
          const result = await this.processOrder(orderData);

          if (result.success) {
            this.showSuccess(result.order_id);
          } else {
            alert('Failed to place order: ' + result.error);
            btn.disabled = false;
            btn.textContent = 'Place Order';
          }
        } catch (error) {
          console.error('Order placement error:', error);
          alert('Error placing order. Please try again.');
          const btn = document.getElementById('placeOrderBtn');
          btn.disabled = false;
          btn.textContent = 'Place Order';
        }
      }

      validateForm() {
        const required = ['firstName', 'lastName', 'email', 'phone', 'address', 'city', 'region'];

        for (const field of required) {
          const element = document.getElementById(field);
          if (!element.value.trim()) {
            alert(`Please fill in ${field.replace(/([A-Z])/g, ' $1').toLowerCase()}`);
            element.focus();
            return false;
          }
        }

        // Email validation
        const email = document.getElementById('email').value;
        if (!this.isValidEmail(email)) {
          alert('Please enter a valid email address');
          return false;
        }

        return true;
      }

      collectOrderData() {
        const paymentMethod = document.querySelector('input[name="payment"]:checked').value;

        return {
          customer: {
            first_name: document.getElementById('firstName').value,
            last_name: document.getElementById('lastName').value,
            email: document.getElementById('email').value,
            phone: document.getElementById('phone').value
          },
          shipping: {
            address: document.getElementById('address').value,
            city: document.getElementById('city').value,
            region: document.getElementById('region').value,
            additional_info: document.getElementById('additionalInfo').value
          },
          payment: {
            method: paymentMethod,
            ...(paymentMethod === 'card' ? {
              card_number: document.getElementById('cardNumber').value,
              expiry_date: document.getElementById('expiryDate').value,
              cvv: document.getElementById('cvv').value,
              cardholder_name: document.getElementById('cardholderName').value
            } : {})
          }
        };
      }

      async processOrder(orderData) {
        // This will call your Odoo API to create the actual order
        return await this.api.placeOrder(orderData);
      }

      showSuccess(orderId) {
        // Redirect to success page or show confirmation
        alert(`Order placed successfully! Order ID: ${orderId}`);
        // Clear cart and redirect
        this.api.clearCart();
        window.location.href = 'order-success.html?order=' + orderId;
      }

      isValidEmail(email) {
        return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
      }

      formatPrice(price) {
        return new Intl.NumberFormat().format(price);
      }

      escapeHtml(unsafe) {
        return unsafe
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }
    }

    // Initialize checkout manager
    document.addEventListener('DOMContentLoaded', () => {
      new CheckoutManager();
    });
  </script>
</body>
</html>